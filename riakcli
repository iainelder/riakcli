#! /usr/bin/env sh

printUsage() {
	echo  "\nUsage:\n"
	echo  "  riakcli list buckets                                   -> Lists all the buckets available in RIAK"
	echo  "  riakcli list keys [bucket-name]                        -> Lists all keys in a given bucket"
	echo  ""
	echo  "  riakcli get object [bucket-name] [key]                 -> Gets the object associated with a given key in a specified bucket"	
	echo  "  riakcli put object [bucket-name] [key] [object-json]   -> Creates/Updates an object for a given key in a specified bucket"
	echo  ""
	echo  "  riakcli delete bucket [bucket-name]                    -> Deletes all objects in a specified bucket"
	echo  "  riakcli delete object [bucket-name] [key]              -> Deletes an object in a given bucket"
	echo  "  riakcli flush                                          -> Deletes all the buckets in RIAK"
	echo  ""
	echo  "  riakcli ping                                           -> Connects to RIAK instance for status"
	echo  "  riakcli help                                           -> Displays this usage information"	
}

printInvalidUsage() {
	echo "\n********************************************************"
	echo "ERROR: Invalid Usage (wrong/missing command arguments)"
	echo "********************************************************"

	printUsage
}

checkForArgs() {
	ARGS_REQUIRED=$1
	shift
	if [ $# -lt $ARGS_REQUIRED ]; then
		printInvalidUsage
		exit	
	fi
}

cput() {	
	local URL=$1
	local DATA=$2
	curl -XPUT -H "Content-Type:application/json" ${URL} -d ${DATA}
}

cdel() {
	local URL=$1
	curl -XDELETE ${URL}
}

listAllBuckets() {
	curl ${RIAK_BASE_URL}/buckets?buckets=true
}

listKeysInBucket() {
	checkForArgs 1 $*
	local BUCKET=$1
	curl ${RIAK_BASE_URL}/buckets/${BUCKET}/keys?keys=true
}

getObject() {
	checkForArgs 2 $*

	local BUCKET=$1
	local KEY=$2

	curl ${RIAK_BASE_URL}/riak/${BUCKET}/${KEY}
}

deleteBucket() {
	checkForArgs 1 $*
	local BUCKET=$1
	
	for KEY in `listKeysInBucket ${BUCKET} | sed -e 's/^.*\[//g' -e 's/"//g' -e 's/\]\}//g' -e 's/,/\'$'\n/g'`;
    do
        deleteObject ${BUCKET} ${KEY}
    done;
}

deleteObject() {
	checkForArgs 2 $*

	local BUCKET=$1
	local KEY=$2

	cdel ${RIAK_BASE_URL}/riak/${BUCKET}/${KEY};
}

putObject() {	
	checkForArgs 3 $*

	local BUCKET=$1
	local KEY=$2
	shift 2	

	local OBJECT=$* 
	OBJECT=`echo ${OBJECT} | sed "s/ //g"`
	cput ${RIAK_BASE_URL}/riak/${BUCKET}/${KEY} ${OBJECT}
}

flush() {
	for BUCKET in  `listAllBuckets | cut -d ':' -f2 | sed -e 's/^.*\[//g' -e 's/"//g' -e 's/\]\}//g' -e 's/,/\'$'\n/g'`;
	do
		echo "Deleting bucket - ${BUCKET}"
		deleteBucket ${BUCKET}
	done;
}

put() {
	case "$1" in
		"object" )
			shift
			putObject $*
			;;
		* )
			printInvalidUsage			
			;;
	esac
}

list() {
	case "$1" in
		"buckets" )			
			listAllBuckets
			;;
		"keys" )
			shift			
			listKeysInBucket $*
			;;
		* )
			printInvalidUsage			
			;;
	esac	
}

get() {
	case "$1" in
		"object" )
			shift 			
			getObject $*
			;;
		* )
			printInvalidUsage			
			;;
	esac	
}

delete() {
	case "$1" in
		"bucket" )
			shift
			deleteBucket $*
			;;
		"object" )
			shift
			deleteObject $*
			;;
		* )
			printInvalidUsage			
			;;			
	esac
}

ping() {
	curl ${RIAK_BASE_URL}/ping
}

__init__() {

	RIAK_HOST="localhost"
	RIAK_PORT=8098

	if [ -f "$HOME/.riakclirc" ]; then . "$HOME/.riakclirc"; fi

	export RIAK_PORT RIAK_PORT
	RIAK_BASE_URL="http://${RIAK_HOST}:${RIAK_PORT}"
	export RIAK_BASE_URL



	case "$1" in
		"help" )
			printUsage
			;;
		"ping" )
			ping
			;;
		"put" )
			shift
			put $*
			;;
		"get" )
			shift
			get $*
			;;
		"list" )
			shift
			list $*
			;;
		"delete" )
			shift
			delete $*
			;;
		"flush" )
			flush
			;;
		* )
			printUsage
			;;
	esac	
}

__init__ $*